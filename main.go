package main

import (
	"bytes"
	"encoding/base64"
	"encoding/json"
	"fmt"
	"log"
	"time"

	"github.com/pkg/errors"
	"github.com/snowplow/snowplow-golang-analytics-sdk/analytics"
)

// A Base64 Encoded TSV Snowplow Payload, which includes JSON in some columns
// We'll use Snowplow Analytics SDK to parse the parts we want.
// We are interested in the derived contexts ... see below
const data = "c253Y2F0CXdlYgkyMDIyLTAzLTIxIDIyOjEyOjQ0Ljc5MAkyMDIyLTAzLTIxIDIyOjEyOjQzLjM1OAkyMDIyLTAzLTIxIDIyOjEyOjQzLjAwNwlwYWdlX3ZpZXcJOWZkNWZkMDYtMjRhZC00NzFiLTlmNzMtZjFhMDU0Y2IwYjMxCQljZglqcy0yLjE0LjAJc3NjLTIuMy4wLWtpbmVzaXMJc3RyZWFtLTIuMC4xLWNvbW1vbi0yLjAuMQlqb2FvY29ycmVpYQk3NS44MC4xMTAuMTg2CQlkNjdiYTkzYS0wYWRhLTRmMDQtYThjZS05NjM0ZDE0ZmE5YzkJMzYJNzdhMDZhN2YtNThiMi00NjRjLTg5MTYtNjUzZWRkOGQ2Nzg4CQkJCQkJCQkJCQkJaHR0cHM6Ly93d3cuc25vd2NhdGNsb3VkLmNvbS9maW5nZXJwcmludAlTbm93Y2F0Q2xvdWQ6IEhvc3RlZCBTbm93cGxvdyBBbmFseXRpY3MJCWh0dHBzCXd3dy5zbm93Y2F0Y2xvdWQuY29tCTQ0MwkvZmluZ2VycHJpbnQJCQkJCQkJCQkJCQkJCQkJCXsic2NoZW1hIjoiaWdsdTpjb20uc25vd3Bsb3dhbmFseXRpY3Muc25vd3Bsb3cvY29udGV4dHMvanNvbnNjaGVtYS8xLTAtMCIsImRhdGEiOlt7InNjaGVtYSI6ImlnbHU6Y29tLmZpbmdlcnByaW50anMvZmluZ2VycHJpbnQvanNvbnNjaGVtYS8xLTAtMCIsImRhdGEiOnsidmlzaXRvcklkIjoibm1uWTNORWUwbEdKYzR0emg1S00iLCJ2aXNpdG9yRm91bmQiOnRydWUsInJlcXVlc3RJZCI6IjE2NDc5MDA3NjI5NjYuV2NpeG9YIiwiY29uZmlkZW5jZSI6eyJzY29yZSI6MC45OTg2NDY5MjE3NDY5NzQzfX19LHsic2NoZW1hIjoiaWdsdTpjb20uY2xlYXJiaXQvY29tcGFueS9qc29uc2NoZW1hLzEtMC0wIiwiZGF0YSI6eyJuYW1lIjoiU25vd2NhdENsb3VkIiwiZG9tYWluIjoic25vd2NhdGNsb3VkLmNvbSIsImdlby5jb3VudHJ5IjoiVW5pdGVkIFN0YXRlcyIsImdlby5zdGF0ZSI6IkNhbGlmb3JuaWEiLCJnZW8uY2l0eSI6IlNhbiBEaWVnbyIsIm1ldHJpY3MuYW5udWFsUmV2ZW51ZSI6bnVsbCwibWV0cmljcy5lbXBsb3llZXMiOjUsInRhZ3MiOlsiSW50ZXJuZXQiXSwidGVjaCI6WyJnb29nbGVfYXBwcyIsImNsb3VkX2ZsYXJlIiwiemVuZGVzayIsInNlbmRncmlkIiwiaGVyb2t1IiwibWFuZHJpbGwiLCJhbWF6b25fc2VzIiwiZ29vZ2xlX3RhZ19tYW5hZ2VyIiwiY3VzdG9tZXJfaW8iLCJmYWNlYm9va19hZHZlcnRpc2VyIiwic25vd3Bsb3dfYW5hbHl0aWNzIiwiZ29vZ2xlX2FuYWx5dGljcyJdLCJpbmR1c3RyeSI6IkludGVybmV0IFNvZnR3YXJlICYgU2VydmljZXMiLCJzZWN0b3IiOiJJbmZvcm1hdGlvbiBUZWNobm9sb2d5IiwiaW5kdXN0cnlHcm91cCI6IlNvZnR3YXJlICYgU2VydmljZXMiLCJzaXRlLnVybCI6InNub3djYXRjbG91ZC5jb20ifX0seyJzY2hlbWEiOiJpZ2x1OmNvbS5zbm93Y2F0Y2xvdWQuaWNlYmVyZy9ncm91cC9qc29uc2NoZW1hLzEtMC0wIiwiZGF0YSI6eyJpZCI6InNub3djYXRjbG91ZC5jb20iLCJuYW1lIjoiU25vd2NhdENsb3VkIiwiZG9tYWluIjoic25vd2NhdGNsb3VkLmNvbSJ9fSx7InNjaGVtYSI6ImlnbHU6Y29tLnNub3dwbG93YW5hbHl0aWNzLnNub3dwbG93L3dlYl9wYWdlL2pzb25zY2hlbWEvMS0wLTAiLCJkYXRhIjp7ImlkIjoiOTY4OTY1NmUtZWJhYi00YzEwLTk0MTMtNTlhNmRjZWZhZGQyIn19LHsic2NoZW1hIjoiaWdsdTpvcmcudzMvUGVyZm9ybWFuY2VUaW1pbmcvanNvbnNjaGVtYS8xLTAtMCIsImRhdGEiOnsibmF2aWdhdGlvblN0YXJ0IjoxNjQ3OTAwNzYxNzM1LCJ1bmxvYWRFdmVudFN0YXJ0IjoxNjQ3OTAwNzYxOTA1LCJ1bmxvYWRFdmVudEVuZCI6MTY0NzkwMDc2MTkwNSwicmVkaXJlY3RTdGFydCI6MCwicmVkaXJlY3RFbmQiOjAsImZldGNoU3RhcnQiOjE2NDc5MDA3NjE3MzcsImRvbWFpbkxvb2t1cFN0YXJ0IjoxNjQ3OTAwNzYxNzM3LCJkb21haW5Mb29rdXBFbmQiOjE2NDc5MDA3NjE3MzcsImNvbm5lY3RTdGFydCI6MTY0NzkwMDc2MTczNywiY29ubmVjdEVuZCI6MTY0NzkwMDc2MTczNywic2VjdXJlQ29ubmVjdGlvblN0YXJ0IjowLCJyZXF1ZXN0U3RhcnQiOjE2NDc5MDA3NjE3MzcsInJlc3BvbnNlU3RhcnQiOjE2NDc5MDA3NjE4MDMsInJlc3BvbnNlRW5kIjoxNjQ3OTAwNzYxOTUyLCJkb21Mb2FkaW5nIjoxNjQ3OTAwNzYxOTExLCJkb21JbnRlcmFjdGl2ZSI6MTY0NzkwMDc2MjA1OCwiZG9tQ29udGVudExvYWRlZEV2ZW50U3RhcnQiOjE2NDc5MDA3NjIyNTUsImRvbUNvbnRlbnRMb2FkZWRFdmVudEVuZCI6MTY0NzkwMDc2MjI1NSwiZG9tQ29tcGxldGUiOjAsImxvYWRFdmVudFN0YXJ0IjowLCJsb2FkRXZlbnRFbmQiOjB9fV19CQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCU1vemlsbGEvNS4wIChNYWNpbnRvc2g7IEludGVsIE1hYyBPUyBYIDEwXzE1XzcpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS85OS4wLjQ4NDQuNzQgU2FmYXJpLzUzNy4zNgkJCQkJCWVuLVVTCTEJMAkwCTAJMAkwCTAJMAkwCTEJMjQJMjEzNQkzODAJCQkJQW1lcmljYS9Mb3NfQW5nZWxlcwkJCTM0NDAJMTQ0MAlVVEYtOAkyMTM1CTYzNDQJCQkJCQkJCQkJCQkyMDIyLTAzLTIxIDIyOjEyOjQzLjEzOQkJCXsic2NoZW1hIjoiaWdsdTpjb20uc25vd3Bsb3dhbmFseXRpY3Muc25vd3Bsb3cvY29udGV4dHMvanNvbnNjaGVtYS8xLTAtMSIsImRhdGEiOlt7InNjaGVtYSI6ImlnbHU6Y29tLnNub3dwbG93YW5hbHl0aWNzLnNub3dwbG93L3VhX3BhcnNlcl9jb250ZXh0L2pzb25zY2hlbWEvMS0wLTAiLCJkYXRhIjp7InVzZXJhZ2VudEZhbWlseSI6IkNocm9tZSIsInVzZXJhZ2VudE1ham9yIjoiOTkiLCJ1c2VyYWdlbnRNaW5vciI6IjAiLCJ1c2VyYWdlbnRQYXRjaCI6IjQ4NDQiLCJ1c2VyYWdlbnRWZXJzaW9uIjoiQ2hyb21lIDk5LjAuNDg0NCIsIm9zRmFtaWx5IjoiTWFjIE9TIFgiLCJvc01ham9yIjoiMTAiLCJvc01pbm9yIjoiMTUiLCJvc1BhdGNoIjoiNyIsIm9zUGF0Y2hNaW5vciI6bnVsbCwib3NWZXJzaW9uIjoiTWFjIE9TIFggMTAuMTUuNyIsImRldmljZUZhbWlseSI6Ik90aGVyIn19LHsic2NoZW1hIjoiaWdsdTpubC5iYXNqZXMveWF1YWFfY29udGV4dC9qc29uc2NoZW1hLzEtMC0yIiwiZGF0YSI6eyJkZXZpY2VCcmFuZCI6IkFwcGxlIiwiZGV2aWNlTmFtZSI6IkFwcGxlIE1hY2ludG9zaCIsIm9wZXJhdGluZ1N5c3RlbVZlcnNpb25NYWpvciI6IjEwIiwibGF5b3V0RW5naW5lTmFtZVZlcnNpb24iOiJCbGluayA5OS4wIiwib3BlcmF0aW5nU3lzdGVtTmFtZVZlcnNpb24iOiJNYWMgT1MgWCAxMC4xNS43IiwibGF5b3V0RW5naW5lTmFtZVZlcnNpb25NYWpvciI6IkJsaW5rIDk5Iiwib3BlcmF0aW5nU3lzdGVtTmFtZSI6Ik1hYyBPUyBYIiwiYWdlbnRWZXJzaW9uTWFqb3IiOiI5OSIsImxheW91dEVuZ2luZVZlcnNpb25NYWpvciI6Ijk5IiwiZGV2aWNlQ2xhc3MiOiJEZXNrdG9wIiwiYWdlbnROYW1lVmVyc2lvbk1ham9yIjoiQ2hyb21lIDk5Iiwib3BlcmF0aW5nU3lzdGVtTmFtZVZlcnNpb25NYWpvciI6Ik1hYyBPUyBYIDEwIiwiZGV2aWNlQ3B1Qml0cyI6IjMyIiwib3BlcmF0aW5nU3lzdGVtQ2xhc3MiOiJEZXNrdG9wIiwibGF5b3V0RW5naW5lTmFtZSI6IkJsaW5rIiwiYWdlbnROYW1lIjoiQ2hyb21lIiwiYWdlbnRWZXJzaW9uIjoiOTkuMC40ODQ0Ljc0IiwibGF5b3V0RW5naW5lQ2xhc3MiOiJCcm93c2VyIiwiYWdlbnROYW1lVmVyc2lvbiI6IkNocm9tZSA5OS4wLjQ4NDQuNzQiLCJvcGVyYXRpbmdTeXN0ZW1WZXJzaW9uIjoiMTAuMTUuNyIsImRldmljZUNwdSI6IkludGVsIiwiYWdlbnRDbGFzcyI6IkJyb3dzZXIiLCJsYXlvdXRFbmdpbmVWZXJzaW9uIjoiOTkuMCJ9fSx7InNjaGVtYSI6ImlnbHU6b3JnLmlldGYvaHR0cF9jb29raWUvanNvbnNjaGVtYS8xLTAtMCIsImRhdGEiOnsibmFtZSI6Il9nYWV4cCIsInZhbHVlIjoiZ2FleHB2YWx1ZSJ9fSx7InNjaGVtYSI6ImlnbHU6b3JnLmlldGYvaHR0cF9jb29raWUvanNvbnNjaGVtYS8xLTAtMCIsImRhdGEiOnsibmFtZSI6ImFqc191c2VyX2lkIiwidmFsdWUiOiJhanN1c2VyaWR2YWx1ZSJ9fSx7InNjaGVtYSI6ImlnbHU6b3JnLmlldGYvaHR0cF9jb29raWUvanNvbnNjaGVtYS8xLTAtMCIsImRhdGEiOnsibmFtZSI6ImNhcnQiLCJ2YWx1ZSI6ImNhcnR2YWx1ZWV4YW1wbGUifX0seyJzY2hlbWEiOiJpZ2x1Om9yZy5pZXRmL2h0dHBfY29va2llL2pzb25zY2hlbWEvMS0wLTAiLCJkYXRhIjp7Im5hbWUiOiJhanNfYW5vbnltb3VzX2lkIiwidmFsdWUiOiJhanNfYW5vbnltb3VzX2lkdmFsdWUifX0seyJzY2hlbWEiOiJpZ2x1Om9yZy5pZXRmL2h0dHBfaGVhZGVyL2pzb25zY2hlbWEvMS0wLTAiLCJkYXRhIjp7Im5hbWUiOiJYLUZvcndhcmRlZC1Gb3IiLCJ2YWx1ZSI6Ijc1LjgwLjExMC4xODYifX0seyJzY2hlbWEiOiJpZ2x1Om9yZy5pZXRmL2h0dHBfaGVhZGVyL2pzb25zY2hlbWEvMS0wLTAiLCJkYXRhIjp7Im5hbWUiOiJIb3N0IiwidmFsdWUiOiJzcC5zbm93Y2F0Y2xvdWQuY29tIn19LHsic2NoZW1hIjoiaWdsdTpvcmcuaWV0Zi9odHRwX2hlYWRlci9qc29uc2NoZW1hLzEtMC0wIiwiZGF0YSI6eyJuYW1lIjoiVXNlci1BZ2VudCIsInZhbHVlIjoiTW96aWxsYS81LjAgKE1hY2ludG9zaDsgSW50ZWwgTWFjIE9TIFggMTBfMTVfNykgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzk5LjAuNDg0NC43NCBTYWZhcmkvNTM3LjM2In19LHsic2NoZW1hIjoiaWdsdTpvcmcuaWV0Zi9odHRwX2hlYWRlci9qc29uc2NoZW1hLzEtMC0wIiwiZGF0YSI6eyJuYW1lIjoiT3JpZ2luIiwidmFsdWUiOiJodHRwczovL3d3dy5zbm93Y2F0Y2xvdWQuY29tIn19LHsic2NoZW1hIjoiaWdsdTpvcmcuaWV0Zi9odHRwX2hlYWRlci9qc29uc2NoZW1hLzEtMC0wIiwiZGF0YSI6eyJuYW1lIjoiUmVmZXJlciIsInZhbHVlIjoiaHR0cHM6Ly93d3cuc25vd2NhdGNsb3VkLmNvbS8ifX0seyJzY2hlbWEiOiJpZ2x1OmNvbS5kYmlwL2xvY2F0aW9uL2pzb25zY2hlbWEvMS0wLTAiLCJkYXRhIjp7ImNpdHkiOnsiZ2VvbmFtZV9pZCI6NTM0MjM1MywibmFtZXMiOnsiZW4iOiJEZWwgTWFyIiwiZmEiOiLYr9mEINmF2KfYsdiMINqp2KfZhNuM2YHYsdmG24zYpyIsImphIjoi44OH44Or44O744Oe44O8IiwiemgtQ04iOiLlvrflsJTpqawifX0sImNvbnRpbmVudCI6eyJjb2RlIjoiTkEiLCJnZW9uYW1lX2lkIjo2MjU1MTQ5LCJuYW1lcyI6eyJkZSI6Ik5vcmRhbWVyaWthIiwiZW4iOiJOb3J0aCBBbWVyaWNhIiwiZXMiOiJOb3J0ZWFtw6lyaWNhIiwiZmEiOiIg2KfZhdix24zaqdin24wg2LTZhdin2YTbjCIsImZyIjoiQW3DqXJpcXVlIER1IE5vcmQiLCJqYSI6IuWMl+OCouODoeODquOCq+Wkp+mZuCIsImtvIjoi67aB7JWE66mU66as7Lm0IiwicHQtQlIiOiJBbcOpcmljYSBEbyBOb3J0ZSIsInJ1Ijoi0KHQtdCy0LXRgNC90LDRjyDQkNC80LXRgNC40LrQsCIsInpoLUNOIjoi5YyX576O5rSyIn19LCJjb3VudHJ5Ijp7Imdlb25hbWVfaWQiOjYyNTIwMDEsImlzX2luX2V1cm9wZWFuX3VuaW9uIjpmYWxzZSwiaXNvX2NvZGUiOiJVUyIsIm5hbWVzIjp7ImRlIjoiVmVyZWluaWd0ZSBTdGFhdGVuIHZvbiBBbWVyaWthIiwiZW4iOiJVbml0ZWQgU3RhdGVzIiwiZXMiOiJFc3RhZG9zIFVuaWRvcyBkZSBBbcOpcmljYSAobG9zKSIsImZhIjoi2KfbjNin2YTYp9iqINmF2KrYrdiv2YfZlCDYp9mF2LHbjNqp2KciLCJmciI6IsOJdGF0cy1VbmlzIiwiamEiOiLjgqLjg6Hjg6rjgqvlkIjooYblm70iLCJrbyI6IuuvuOq1rSIsInB0LUJSIjoiRXN0YWRvcyBVbmlkb3MiLCJydSI6ItCh0KjQkCIsInpoLUNOIjoi576O5Zu9In19LCJsb2NhdGlvbiI6eyJsYXRpdHVkZSI6MzIuOTU5NSwibG9uZ2l0dWRlIjotMTE3LjI2NSwidGltZV96b25lIjoiQW1lcmljYS9Mb3NfQW5nZWxlcyIsIndlYXRoZXJfY29kZSI6IlVTQ0EwMjg4In0sInBvc3RhbCI6eyJjb2RlIjoiOTIwMTQifSwic3ViZGl2aXNpb25zIjpbeyJnZW9uYW1lX2lkIjo1MzMyOTIxLCJpc29fY29kZSI6IkNBIiwibmFtZXMiOnsiZGUiOiJLYWxpZm9ybmllbiIsImVuIjoiQ2FsaWZvcm5pYSIsImVzIjoiQ2FsaWZvcm5pYSIsImZhIjoi2qnYp9mE24zZgdix2YbbjNinIiwiZnIiOiJDYWxpZm9ybmllIiwiamEiOiLjgqvjg6rjg5Xjgqnjg6vjg4vjgqLlt54iLCJrbyI6Iuy6mOumrO2PrOuLiOyVhCDso7wiLCJwdC1CUiI6IkNhbGlmw7NybmlhIiwicnUiOiLQmtCw0LvQuNGE0L7RgNC90LjRjyIsInpoLUNOIjoi5Yqg5beeIn19LHsiZ2VvbmFtZV9pZCI6NTM5MTgzMiwibmFtZXMiOnsiZW4iOiJTYW4gRGllZ28iLCJlcyI6IkNvbmRhZG8gZGUgU2FuIERpZWdvIiwiZmEiOiLYtNmH2LHYs9iq2KfZhiDYs9mGINiv24zar9mI2Iwg2qnYp9mE24zZgdix2YbbjNinIiwiZnIiOiJDb210w6kgZGUgU2FuIERpZWdvIiwiamEiOiLjgrXjg7Pjg4fjgqPjgqjjgrTpg6EiLCJrbyI6IuyDjOuUlOyXkOydtOqzoCDqtbAiLCJwdC1CUiI6IkNvbmRhZG8gZGUgU2FuIERpZWdvIiwicnUiOiLQodCw0L0t0JTQuNC10LPQviIsInpoLUNOIjoi5Zyj6L+t5oiI5Y6/In19XX19LHsic2NoZW1hIjoiaWdsdTpjb20uZGJpcC9pc3AvanNvbnNjaGVtYS8xLTAtMCIsImRhdGEiOnsidHJhaXRzIjp7ImF1dG9ub21vdXNfc3lzdGVtX251bWJlciI6MjAwMDEsImF1dG9ub21vdXNfc3lzdGVtX29yZ2FuaXphdGlvbiI6IkNoYXJ0ZXIgQ29tbXVuaWNhdGlvbnMgSW5jIiwiY29ubmVjdGlvbl90eXBlIjoiQ29ycG9yYXRlIiwiaXNwIjoiQ2hhcnRlciBDb21tdW5pY2F0aW9ucyIsIm9yZ2FuaXphdGlvbiI6IlNwZWN0cnVtIn19fV19CTc2MjU1MzkwLTcxMTUtNGFhMC04YTIzLWExYjFkNGVmOGQ3YwkyMDIyLTAzLTIxIDIyOjEyOjQzLjIyNgljb20uc25vd3Bsb3dhbmFseXRpY3Muc25vd3Bsb3cJcGFnZV92aWV3CWpzb25zY2hlbWEJMS0wLTAJZWNhMjNmN2NmYzBjNzYzZTk2Y2U0ZGUyYmI3YWQyNzMJ"

// Decodes and parses base64 encoded TSV event
func parseBase64EncodedEvent(event string) (analytics.ParsedEvent, error) {
	tsv, err := DecodeBase64Payload(event)
	if err != nil {
		return nil, errors.Wrap(err, "failed decode base64 data")
	}

	parsed, err := analytics.ParseEvent(tsv)
	if err != nil {
		return nil, errors.Wrap(err, "failed parse TSV event")
	}

	return parsed, nil
}

func main() {
	start := time.Now()

	parsed, err := parseBase64EncodedEvent(data)
	if err != nil {
		log.Fatal(err)
	}

	jsonData, err := parsed.ToJson()
	if err != nil {
		log.Fatal("failed parse TSV to json:", err)
	}

	log.Println("#################################")
	elapsed := time.Since(start)

	fmt.Println(prettyJson(jsonData))

	log.Printf("#### Function took %s ####\n", elapsed)
	log.Println("#################################")
}

// Decodes the Base64 Encoded Payload
func DecodeBase64Payload(payload string) (string, error) {
	sDec, err := base64.StdEncoding.DecodeString(payload)
	if err != nil {
		log.Fatalf("Failed to decode Base64 %v", err)
	}
	return string(sDec), err
}

// Formats JSON string
func prettyJson(jsonData []byte) string {
	var prettyJSON bytes.Buffer
	err := json.Indent(&prettyJSON, jsonData, "", "  ")
	if err != nil {
		log.Fatal("JSON parse error: ", err)
	}

	return string(prettyJSON.Bytes())
}
